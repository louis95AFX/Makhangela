<!DOCTYPE html>
<html lang="en">
<head>


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MMSSE Admin | Manage Updates</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-50 font-inter">
    <custom-header></custom-header>
    <div class="container mx-auto px-4 py-4 flex flex-wrap gap-4 justify-between items-center">

    <!-- Home button -->
    <a href="index.html" 
       class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg shadow-md transition flex items-center">
        <i data-feather="home" class="w-4 h-4 mr-2"></i>
        Home
    </a>

    <!-- View All Updates button -->
    <a href="updates.html" 
       class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-md transition flex items-center">
        <i data-feather="arrow-right" class="w-4 h-4 mr-2"></i>
        View All Updates
    </a>

    <!-- Edit Updates button -->
    <a href="adminUpdates.html" 
       class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-md transition flex items-center">
        <i data-feather="edit-3" class="w-4 h-4 mr-2"></i>
        Edit Updates
    </a>

</div>



<main class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">New Update</h1>
            <p class="text-gray-500 max-w-md mx-auto">Create and publish new announcements for students and staff</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-emerald-500">
            <form id="updateForm" class="p-6 md:p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Update Title *</label>
                        <input type="text" id="title" name="Title" required 
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition"
                            placeholder="e.g., Important: 2026 Registration Open">
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                        <input type="date" id="date" name="Date" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                        <select id="category" name="Category" required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                            <option value="">Select a Category</option>
                            <option value="Important Announcement">Important Announcement</option>
                            <option value="Registration Update">Registration Update</option>
                            <option value="Program Details">Program Details</option>
                            <option value="Staff News">Staff News</option>
                            <option value="Video/Photo Post">Video/Photo Post</option>
                            <option value="General News">General News</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label for="content" class="block text-sm font-medium text-gray-700 mb-1">Full Description *</label>
                        <textarea id="content" name="Content" required rows="5"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition"
                            placeholder="Type the full update message here..."></textarea>
                    </div>

                    <div class="md:col-span-2">
                        <label for="mediaUrl" class="block text-sm font-medium text-gray-700 mb-1">Optional Media URL</label>
                        <input type="url" id="mediaUrl" name="MediaURL"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition"
                            placeholder="Paste a public image/video link (optional)">
                        <p class="text-xs text-gray-500 mt-1 flex items-center">
                            <i data-feather="info" class="w-4 h-4 mr-1"></i>
                            OR upload a file from your device below
                        </p>
                    </div>

                    <div class="md:col-span-2">
                        <label for="mediaFile" class="block text-sm font-medium text-gray-700 mb-1">Upload Image/Video</label>
                        <div class="flex items-center">
                            <label class="flex flex-col items-center px-4 py-6 bg-white rounded-lg border border-dashed border-gray-300 cursor-pointer hover:bg-gray-50 transition w-full">
                                <div class="flex flex-col items-center">
                                    <i data-feather="upload" class="w-8 h-8 text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">
                                        <span class="font-semibold text-emerald-600">Click to upload</span> or drag and drop
                                    </p>
                                </div>
                                <input type="file" id="mediaFile" name="MediaFile" class="hidden" accept="image/*,video/*">
                            </label>
                        </div>
                        <div id="previewContainer" class="mt-2"></div>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" id="submitBtn" class="w-full flex items-center justify-center px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                        <i data-feather="send" class="w-5 h-5 mr-2"></i>
                        Publish Update
                    </button>
                </div>

                <div id="status-message" class="mt-4 text-center text-sm"></div>
            </form>
        </div>
    </main>
    <custom-footer></custom-footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
feather.replace();

const SUPABASE_URL = 'https://vzumdblygtxomnxwuhul.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const updateForm = document.getElementById('updateForm');
const statusMessage = document.getElementById('status-message');
const mediaFileInput = document.getElementById('mediaFile');
const previewContainer = document.getElementById('previewContainer');

// Preview file
mediaFileInput.addEventListener('change', function() {
    previewContainer.innerHTML = '';
    if (this.files && this.files[0]) {
        const file = this.files[0];
        const fileType = file.type.split('/')[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            if (fileType === 'image') {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'max-w-xs rounded-lg border border-gray-200 mt-2';
                previewContainer.appendChild(img);
            } else if (fileType === 'video') {
                const video = document.createElement('video');
                video.src = e.target.result;
                video.controls = true;
                video.className = 'max-w-xs rounded-lg border border-gray-200 mt-2';
                previewContainer.appendChild(video);
            }
        };
        reader.readAsDataURL(file);
    }
});

// Form submission
updateForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    statusMessage.textContent = 'Submitting...';
    statusMessage.className = 'mt-4 text-center text-sm text-gray-600';

    const title = updateForm.Title.value;
    const date = updateForm.Date.value;
    const category = updateForm.Category.value;
    const content = updateForm.Content.value;
    const mediaUrl = updateForm.MediaURL.value;

    let mediaLink = mediaUrl;

    if (mediaFileInput.files && mediaFileInput.files[0]) {
        const file = mediaFileInput.files[0];
        const fileExt = file.name.split('.').pop();
        const sanitizedFileName = `${Date.now()}-${file.name.replace(/\s/g, '-')}`;

        // Step 1: request a signed URL from Supabase
        const { data: signedData, error: signedError } = await supabase
            .storage
            .from('media')
            .createSignedUploadUrl(sanitizedFileName, 60); // valid 60s

        if (signedError) {
            statusMessage.textContent = 'Failed to get upload URL: ' + signedError.message;
            statusMessage.className = 'mt-4 text-center text-sm text-red-600';
            return;
        }

        // Step 2: upload file to the signed URL
        const uploadResponse = await fetch(signedData.signedUrl, {
            method: 'PUT',
            body: file
        });

        if (!uploadResponse.ok) {
            statusMessage.textContent = 'File upload failed.';
            statusMessage.className = 'mt-4 text-center text-sm text-red-600';
            return;
        }

        // Step 3: get the public URL for display
        const { data: publicUrlData } = supabase.storage.from('media').getPublicUrl(sanitizedFileName);
        mediaLink = publicUrlData.publicUrl;
    }

    // Insert into updates table
    const { error } = await supabase.from('updates').insert([{
        Title: title,
        Date: date,
        Category: category,
        Content: content,
        MediaURL: mediaLink
    }]);

    if (error) {
        statusMessage.textContent = 'Submission failed: ' + error.message;
        statusMessage.className = 'mt-4 text-center text-sm text-red-600';
    } else {
        statusMessage.textContent = 'Update submitted successfully!';
        statusMessage.className = 'mt-4 text-center text-sm text-green-600';
        updateForm.reset();
        previewContainer.innerHTML = '';
    }
});
</script>

<script src="server.js"></script> 
</body>
</html>
